<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BatteryAngle 配置</title>
  <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css">
  <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
  <style>
    .main-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    .config-card {
      margin: 16px 0;
    }

    #status {
      margin-top: 20px;
      padding: 16px;
    }
  </style>
</head>

<body class="mdui-theme-auto">
  <mdui-top-app-bar>
    <mdui-top-app-bar-title>BatteryAngle 配置</mdui-top-app-bar-title>
  </mdui-top-app-bar>

  <div class="main-content">
    <div style="display: flex; gap: 16px;">
      <mdui-card class="config-card" style="flex: 1;">
        <mdui-card-content style="padding: 8px; gap: 10px; display: grid;">
          <mdui-text-field id="wifi_sta_ssid" label="SSID" variant="outlined"></mdui-text-field>
          <mdui-text-field id="wifi_sta_password" label="Password" type="password" variant="outlined"
            toggle-password></mdui-text-field>
          <mdui-button onclick="submitForm()">提交</mdui-button>
        </mdui-card-content>
      </mdui-card>

      <mdui-card id="status" class="status-card" style="flex: 1;">
        <span>公用 WiFi 连接中...</span>
      </mdui-card>
    </div>
  </div>

  <script>
    function loadConfig() {
      fetch('/get_config')
        .then(response => response.json())
        .then(data => {
          if (data.ssid) document.getElementById("wifi_sta_ssid").value = data.ssid;
          if (data.password) document.getElementById("wifi_sta_password").value = data.password;
        })
        .catch(error => console.error("Error loading config:", error));
    }

    function submitForm() {
      const ssid = document.getElementById(`wifi_sta_ssid`).value;
      const password = document.getElementById(`wifi_sta_password`).value;

      fetch('/set_wifi_ssid_and_passwd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wifi_sta_ssid: ssid,
          wifi_sta_password: password
        })
      }).then(response => response.json())
        .then(data => mdui.snackbar({ message: data.message }))
        .catch(error => console.error("Error:", error));
    }

    async function readStatus() {
      const response = await fetch('/status')
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          try {
            const data = JSON.parse(line.replace(/^data: /, ''));
            const status = document.getElementById("status");
            let message = "公用 WiFi 连接中...";
            let color = "var(--mdui-color-warning)";

            if (data.sta_connected) {
              message = `公用 WiFi 已连接！IP: ${data.ip}`;
              color = "var(--mdui-color-success)";
            } else if (data.sta_error) {
              message = "公用 WiFi 无连接";
              color = "var(--mdui-color-error)";
            }

            message += ` (频率: ${data.frequency})`;
            message += ` (${data.btn_pressed ? "按钮按下" : "按钮未按下"})`;

            status.innerHTML = `<span style="color: ${color}">${message}</span>`;
          } catch (error) {
            console.error("Error parsing status:", error);
          }
        }
      }
    }

    window.onload = loadConfig;
    readStatus();
  </script>
</body>

</html>